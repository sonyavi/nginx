  stages:
    - validate
    - deploy

  variables:
    ANSIBLE_HOST_KEY_CHECKING: "False"
    ANSIBLE_FORCE_COLOR: "true"

  # ÐžÐ±Ñ€Ð°Ð· Ñ Ansible
  image: python:3.12-slim

  before_script:
    - apt-get update -qq && apt-get install -y -qq openssh-client ansible
    - ansible-galaxy collection install -r requirements.yml
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH ÐºÐ»ÑŽÑ‡Ð° Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ GitLab CI/CD
    - |
      if [ -n "$SSH_PRIVATE_KEY" ]; then
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $ANSIBLE_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
      fi
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ inventory Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
    - |
      {
        echo "---"
        echo "all:"
        echo "  hosts:"
        echo "    ${ANSIBLE_HOST_NAME:-vm-nginx}:"
        echo "      ansible_host: $ANSIBLE_HOST"
        echo "      ansible_user: ${ANSIBLE_USER:-ubuntu}"
        if [ -n "$SSH_PRIVATE_KEY" ]; then
          echo "      ansible_ssh_private_key_file: ~/.ssh/id_rsa"
        elif [ -n "$ANSIBLE_SSH_PASS" ]; then
          echo "      ansible_ssh_pass: \"$ANSIBLE_SSH_PASS\""
        fi
        if [ -n "$ANSIBLE_BECOME_PASS" ]; then
          echo "      ansible_become_pass: \"$ANSIBLE_BECOME_PASS\""
        fi
      } > inventory.ci.yml
    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ansible.cfg Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
    
    - |
      cat > ansible.ci.cfg <<EOF
      [defaults]
      inventory = inventory.ci.yml
      host_key_checking = False
      retry_files_enabled = False
      remote_tmp = /tmp/.ansible-tmp
      [privilege_escalation]
      become = True
      become_method = sudo
      EOF
    - export ANSIBLE_CONFIG=ansible.ci.cfg
    - cat inventory.ci.yml

  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ°
  validate:
    stage: validate
    script:
      - echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° Ansible playbook..."
      - ansible-playbook --syntax-check playbook.yml
      - echo "âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½!"
    only:
      - merge_requests
      - main
      - master
      - develop

  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
  test-connection:
    stage: validate
    script:
      - echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ñ…Ð¾ÑÑ‚Ñƒ..."
      - ansible all -m ping
      - echo "âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
    only:
      - main
      - master
    when: manual
    allow_failure: true

  # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð² staging
  deploy-staging:
    stage: deploy
    script:
      - echo "ðŸš€ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° staging Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
      - ansible-playbook playbook.yml
      - echo "âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
      - echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°..."
      - ansible all -m shell -a "docker ps | grep nginx" || true
      - ansible all -m shell -a "curl -I http://localhost" || true
    environment:
      name: staging
    only:
      - develop
      - staging
    when: manual

  # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð² production
  deploy-production:
    stage: deploy
    script:
      - echo "ðŸš€ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° production Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
      - ansible-playbook playbook.yml
      - echo "âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
      - echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°..."
      - ansible all -m shell -a "docker ps | grep nginx" || true
      - ansible all -m shell -a "curl -I http://localhost" || true
    environment:
      name: production
    only:
      - main
      - master
    when: manual
