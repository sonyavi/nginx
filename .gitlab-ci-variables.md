# GitLab CI/CD Variables Configuration

Для работы GitLab CI/CD необходимо настроить следующие переменные в настройках проекта GitLab:

**Settings → CI/CD → Variables → Expand**

## Обязательные переменные

### ANSIBLE_HOST
IP адрес или hostname целевого хоста для развертывания.

**Пример:** `192.168.64.8`

### ANSIBLE_USER
Пользователь для SSH подключения к целевому хосту.

**Пример:** `ubuntu` или `sonyavi`

## Вариант 1: SSH ключ (рекомендуется)

### SSH_PRIVATE_KEY
Приватный SSH ключ для подключения к целевому хосту. 

**Как получить:**
```bash
cat ~/.ssh/id_rsa
```

**Настройка в GitLab:**
- Type: Variable
- Key: `SSH_PRIVATE_KEY`
- Value: содержимое приватного ключа (начинается с `-----BEGIN OPENSSH PRIVATE KEY-----`)
- Protected: ✅ (рекомендуется)
- Masked: ❌ (нельзя маскировать многострочные значения)

**Настройка на целевом хосте:**
```bash
# На целевой машине добавьте публичный ключ в authorized_keys
cat ~/.ssh/id_rsa.pub | ssh user@target-host "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

## Вариант 2: Пароли (менее безопасно)

Если SSH ключ недоступен, можно использовать пароли:

### ANSIBLE_SSH_PASS
Пароль для SSH подключения.

**Настройка:**
- Type: Variable
- Key: `ANSIBLE_SSH_PASS`
- Value: пароль для SSH
- Protected: ✅
- Masked: ✅

### ANSIBLE_BECOME_PASS
Пароль для sudo на целевом хосте.

**Настройка:**
- Type: Variable
- Key: `ANSIBLE_BECOME_PASS`
- Value: пароль для sudo
- Protected: ✅
- Masked: ✅

## Опциональные переменные

### ANSIBLE_HOST_NAME
Имя хоста в inventory (по умолчанию: `vm-nginx`).

**Пример:** `web-server-1`

### Переменные для переопределения настроек

Можно добавить переменные для кастомизации развертывания:

- `NGINX_COMPOSE_HOST_PORT` - порт на хосте (по умолчанию: 80)
- `NGINX_COMPOSE_IMAGE` - образ Docker (по умолчанию: nginx:stable-alpine)
- `DOCKER_ENGINE_DOCKER_USERS` - список пользователей для группы docker

## Пример настройки переменных

### Минимальная конфигурация (SSH ключ):

```
ANSIBLE_HOST = 192.168.64.8
ANSIBLE_USER = ubuntu
SSH_PRIVATE_KEY = -----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----
```

### Конфигурация с паролями:

```
ANSIBLE_HOST = 192.168.64.8
ANSIBLE_USER = ubuntu
ANSIBLE_SSH_PASS = your_ssh_password
ANSIBLE_BECOME_PASS = your_sudo_password
```

## Безопасность

1. **Используйте SSH ключи** вместо паролей
2. **Включите Protected** для переменных с секретами
3. **Включите Masked** для паролей (если возможно)
4. **Ограничьте доступ** к переменным только нужным окружениям
5. **Регулярно ротируйте** ключи и пароли

## Проверка настройки

После настройки переменных:

1. Перейдите в **CI/CD → Pipelines**
2. Запустите pipeline вручную
3. Проверьте job `validate` - должен пройти успешно
4. Запустите `test-connection` вручную для проверки подключения

## Troubleshooting

### Ошибка: "Permission denied (publickey)"

- Проверьте, что `SSH_PRIVATE_KEY` содержит полный ключ
- Убедитесь, что публичный ключ добавлен в `~/.ssh/authorized_keys` на целевом хосте
- Проверьте права доступа на целевом хосте: `chmod 600 ~/.ssh/authorized_keys`

### Ошибка: "Host key verification failed"

- Добавьте хост в known_hosts вручную или используйте `ANSIBLE_HOST_KEY_CHECKING: "False"` (уже настроено)

### Ошибка: "sudo: a password is required"

- Убедитесь, что `ANSIBLE_BECOME_PASS` установлен
- Или настройте NOPASSWD на целевом хосте:
  ```bash
  echo "user ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/user
  ```

